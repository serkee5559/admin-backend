<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
<div layout:fragment="content">
  <div class="bg-white p-8 rounded-xl shadow-md">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">⏰ 근태 관리 시스템</h1>
    <!--  캘린더  -->
    <div class="flex items-center justify-center gap-6 mb-8 p-4 bg-gray-50 rounded-xl">
      <a th:href="@{/attendance(date=${prevDate})}" class="p-2 hover:bg-gray-200 rounded-full transition text-gray-600">
        <i data-lucide="chevron-left" class="w-6 h-6"></i>
      </a>

      <div class="relative flex items-center gap-2 cursor-pointer group hover:bg-gray-100 p-2 rounded-lg transition-all z-20" id="datePickerTrigger">
        <i data-lucide="calendar" class="w-5 h-5 text-blue-600 pointer-events-none"></i>
        <span class="text-xl font-semibold text-gray-700 pointer-events-none" th:text="${selectedDate}">2026-01-14</span>
        <input type="hidden" id="dateInput" th:value="${selectedDate}">
        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 group-hover:text-gray-600 pointer-events-none"></i>
      </div>
      <a th:href="@{/attendance(date=${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')})}"
         class="px-3 py-1.5 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 transition shadow-sm">
        오늘
      </a>

      <a th:href="@{/attendance(date=${nextDate})}" class="p-2 hover:bg-gray-200 rounded-full transition text-gray-600">
        <i data-lucide="chevron-right" class="w-6 h-6"></i>
      </a>
    </div>
    <!--//캘린더-->
    <table class="w-full text-left border-collapse">
      <thead>
      <tr class="bg-gray-100 border-b">
        <th class="py-3 px-4">이름</th>
        <th class="py-3 px-4">부서</th>
        <th class="py-3 px-4">오늘의 근태</th>
        <th class="py-3 px-4"></th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="member : ${members}" class="border-b hover:bg-gray-50 transition">
        <td class="py-4 px-4 font-medium" th:text="${member.name}">이름</td>
        <td class="py-4 px-4 text-gray-500" th:text="${member.department}">부서</td>

        <td class="py-4 px-4">
          <div th:with="att=${attendanceMap.get(member.id)}" class="flex flex-col gap-1">
        <span class="w-fit px-3 py-1 rounded-full text-xs font-bold"
              th:with="isLate=${att != null and att.checkInTime != null and att.checkInTime.getHour() >= 9 and att.checkInTime.getMinute() > 0}"
              th:classappend="${att == null ? 'bg-gray-200 text-gray-500' :
                               (isLate ? 'bg-red-100 text-red-600 border border-red-200' :
                               (att.status == '출근' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'))}"
              th:text="${att == null ? '미출근' : (isLate ? '지각' : att.status)}">
        </span>

            <div th:if="${att != null}" class="text-[11px] text-gray-400 mt-1 space-y-0.5">
              <div th:if="${att.checkInTime != null}" class="flex items-center gap-1">
                <i data-lucide="clock" class="w-3 h-3"></i>
                <span>출근: </span>
                <span th:text="${#temporals.format(att.checkInTime, 'HH:mm:ss')}"></span>
              </div>
              <div th:if="${att.checkOutTime != null}" class="flex items-center gap-1">
                <i data-lucide="log-out" class="w-3 h-3"></i>
                <span>퇴근: </span>
                <span th:text="${#temporals.format(att.checkOutTime, 'HH:mm:ss')}"></span>
              </div>
            </div>
          </div>
        </td>

        <td class="py-4 px-4 text-right">
          <div th:with="att=${attendanceMap.get(member.id)}">

            <div th:if="${att != null and att.checkOutTime != null}" class="flex flex-col items-end gap-1">
              <span class="text-gray-400 text-[11px] italic mb-1">오늘 업무 종료</span>
              <span th:with="hours=${att.getWorkingHours()}"
                    class="px-2 py-0.5 rounded text-[10px] font-bold"
                    th:classappend="${hours >= 9 ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}"
                    th:text="${hours + 'h 근무'}">
      </span>
            </div>

            <div th:if="${att != null and att.checkOutTime == null}">
              <form th:action="@{/attendance/checkout/{id}(id=${member.id})}" method="post">
                <input type="hidden" name="date" th:value="${selectedDate}">
                <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm shadow-md">
                  퇴근하기
                </button>
              </form>
            </div>

            <div th:if="${att == null}">
              <form th:action="@{/attendance/checkin/{id}(id=${member.id})}" method="post">
                <input type="hidden" name="date" th:value="${selectedDate}">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm shadow-md">
                  출근하기
                </button>
              </form>
            </div>

          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
  <script th:inline="javascript">
    window.onload = function() {
      const datePickerElement = document.getElementById('datePickerTrigger');

      // 타임리프 변수를 문자열로 안전하게 받기 위해 따옴표 사용
      const selectedDateStr = /*[[${selectedDate.toString()}]]*/ "";

      if (datePickerElement) {
        flatpickr(datePickerElement, {
          defaultDate: selectedDateStr, // 객체가 아닌 문자열 전달
          dateFormat: "Y-m-d",
          disableMobile: true,
          locale: "ko",
          onChange: function(selectedDates, dateStr) {
            if (dateStr) {
              location.href = "/attendance?date=" + dateStr;
            }
          }
        });
        console.log("Flatpickr 한글 버전 초기화 성공!");
      }

      if (typeof lucide !== 'undefined') lucide.createIcons();
    };
  </script>
</div>

</html>